# Camunda BPM Process Engine Plugin
A Plugin for [Camunda BPM](http://docs.camunda.org). 

Apparently it is not possible to access spring beans in an Input/Output mapping script, although the beans are wired correctly. To overcome this inability you can use this plugin. 

## Show me the important parts!

To do so, we implemented the interfaces `org.camunda.bpm.engine.impl.scripting.engine.ResolverFactory` and `org.camunda.bpm.engine.impl.scripting.engine.Resolver` in a way that accesses a Spring application context. We then registered the resolver factory with the engine via the configuration property `resolverFactories`. Accessing beans from a script is now no longer a missing feature!

tl;dr:
  1.  SpringResolver        - your code that resolves string constants to beans at runtime
  2.  SpringResolverFactory - resolve variable in context
  3.  SpringResolverPlugin  - make engine aware of your awesome code
  
 ### Resolve string constants to beans at runtime

Implement the `org.camunda.bpm.engine.impl.scripting.engine.Resolver` interface:

``` java
public class SpringResolver implements Resolver {

  private final ApplicationContext applicationContext;

  private final Set<String> beannames;

  public SpringResolver(final ApplicationContext applicationContext) {
    ensureNotNull("applicationContext", applicationContext);
    this.applicationContext = applicationContext;
    this.beannames = new HashSet<>(Arrays.asList(applicationContext.getBeanDefinitionNames()));
  }

  @Override
  public boolean containsKey(final Object key) {
    return beannames.contains(key);
  }

  @Override
  public Object get(final Object key) {
    return applicationContext.getBean((String) key);
  }

  @Override
  public Set<String> keySet() {
    return beannames;
  }
}
```
 
### Resolve the variable in our context:

Implement the`org.camunda.bpm.engine.impl.scripting.engine.ResolverFactory` interface:
``` java
public class SpringResolverFactory implements ResolverFactory {

  private final ApplicationContext applicationContext;

  public SpringResolverFactory(final ApplicationContext applicationContext) {
    this.applicationContext = applicationContext;
  }

  @Override
  public Resolver createResolver(final VariableScope variableScope) {
    return new SpringResolver(applicationContext);
  }
}
```

### Make the engine aware of our awesome code

Implement the `org.camunda.bpm.engine.impl.cfg.ProcessEnginePlugin` interface:


``` java
public class SpringResolverPlugin implements ProcessEnginePlugin {
  @Autowired
  private ApplicationContext applicationContext;


  @Override
  public void preInit(final ProcessEngineConfigurationImpl processEngineConfiguration) {
    // nothing to do
  }

  @Override
  public void postInit(final ProcessEngineConfigurationImpl processEngineConfiguration) {
    processEngineConfiguration.getResolverFactories().add(new SpringResolverFactory(applicationContext));
  }

  @Override
  public void postProcessEngineBuild(final ProcessEngine processEngine) {
    // nothing to do
  }
}
```

### Still curious?

For more information just check the [camunda forum](https://forum.camunda.org/t/inability-to-access-spring-beans-in-input-output-mapping-script/3310)!


## How to use it?
1.  Checkout the project
2.  Import it into your IDE
3.  [Integrate the plugin into your Camunda BPM configuration](https://docs.camunda.org/manual/latest/user-guide/process-engine/process-engine-plugins/)

### Environment Restrictions / Licence
Built and tested against Camunda BPM version 7.8.0.

This project has been generated by the Maven archetype
[camunda-archetype-engine-plugin-7.9.0](http://docs.camunda.org/latest/guides/user-guide/#process-applications-maven-project-templates-archetypes).

[Apache License, Version 2.0](http://www.apache.org/licenses/LICENSE-2.0).

### Contributors
- robert breske - cimt ag
- ralf musick - gvl
- palossyl - camunda forum

<!-- HTML snippet for index page
  <tr>
    <td><img src="snippets/wfl-plugin-resolver/src/main/resources/process.png" width="100"></td>
    <td><a href="snippets/wfl-plugin-resolver">Camunda BPM Process Engine Plugin</a></td>
    <td>A Plugin for [Camunda BPM](http://docs.camunda.org).</td>
  </tr>
-->
<!-- Tweet
New @CamundaBPM example: Camunda BPM Process Engine Plugin - A Plugin for [Camunda BPM](http://docs.camunda.org). https://github.com/camunda/camunda-consulting/tree/master/snippets/wfl-plugin-resolver
-->
